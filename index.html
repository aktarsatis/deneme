<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nöbetçi24 — Özel Şoför Çağır</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body, html {margin:0; padding:0; font-family:Arial,sans-serif; background:#0b0f14; color:#e6eef8;}
.app {max-width:760px; margin:0 auto; height:100vh; display:flex; flex-direction:column;}
header {padding:10px 14px; font-size:18px;}
#map {flex:1; border-radius:12px; margin:10px 12px; border:1px solid rgba(255,255,255,0.04);}
.sheet {padding:14px; background:rgba(15,23,32,0.9); border-radius:18px; margin:10px 12px; display:flex; flex-direction:column; gap:10px;}
input {padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); width:100%; background:transparent; color:#e6eef8;}
button {padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:600;}
.btn-primary {background:#00c48c; color:#012;}
.result-row {display:flex; gap:10px; margin-top:10px;}
.result {flex:1; text-align:center; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px;}
.result .val {font-weight:700; font-size:16px;}
.result .lbl {font-size:12px; color:#9aa4b2;}
</style>
</head>
<body>
<div class="app">
  <header>Nöbetçi24 — Özel Şoför Çağır</header>

  <div id="map"></div>

  <!-- Step 1: Başlangıç -->
  <div class="sheet" id="step1">
    <div>Başlangıç Konumunu Seç:</div>
    <input type="text" id="startAddress" placeholder="Adres gir">
    <button id="btnSelectStart" class="btn-primary">Konumumu Seç</button>
    <div id="startDisplay"></div>
    <button id="btnStartNext" class="btn-primary" style="display:none;">Onayla & Devam Et</button>
  </div>

  <!-- Step 2: Hedef -->
  <div class="sheet" id="step2" style="display:none;">
    <div>Hedef Konumunu Seç:</div>
    <input type="text" id="destAddress" placeholder="Adres gir">
    <button id="btnDestSearch" class="btn-primary">Seç</button>
    <div id="destDisplay"></div>
    <button id="btnDestNext" class="btn-primary" style="display:none;">Onayla & Devam Et</button>
  </div>

  <!-- Step 3: Özet -->
  <div class="sheet" id="step3" style="display:none;">
    <div>Özet:</div>
    <div class="result-row">
      <div class="result"><div class="val" id="resDistance">—</div><div class="lbl">Mesafe</div></div>
      <div class="result"><div class="val" id="resTime">—</div><div class="lbl">Tahmini Süre</div></div>
      <div class="result"><div class="val" id="resPrice">20 TL</div><div class="lbl">Ücret</div></div>
    </div>
    <button id="btnCallDriver" class="btn-primary" style="margin-top:10px;">Şoför Çağır</button>
  </div>
</div>

<script>
let map, startMarker=null, destMarker=null, routeLine=null;
let startCoord=null, destCoord=null;
let startAddressText="", destAddressText="";
const FIXED_PRICE=20, KM_PRICE=5, AVG_SPEED=20;

// Modern Maptiler Streets (ücretsiz, erişilebilir)
function initMap(){
  map=L.map('map').setView([41.0082,28.9784],12);
  L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=Get_Your_Own_Key', {
    attribution:'&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    tileSize:512,
    zoomOffset:-1,
    maxZoom:20
  }).addTo(map);

  map.on('click', function(e){
    if(document.getElementById('step1').style.display!=='none') setStart(e.latlng.lat,e.latlng.lng);
    else if(document.getElementById('step2').style.display!=='none') setDest(e.latlng.lat,e.latlng.lng);
  });
}

// Geocoding
async function geocode(q){
  try{
    const res=await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q='+encodeURIComponent(q));
    const arr=await res.json();
    if(arr.length>0) return {lat:parseFloat(arr[0].lat), lng:parseFloat(arr[0].lon), display_name:arr[0].display_name};
    return null;
  }catch(e){ return null;}
}

async function reverseGeocode(lat,lng){
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data=await res.json();
    return data.display_name || `${lat.toFixed(5)},${lng.toFixed(5)}`;
  }catch(e){ return `${lat.toFixed(5)},${lng.toFixed(5)}`;}
}

function setStart(lat,lng){
  startCoord={lat,lng};
  const iconStart=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3135/3135715.png', iconSize:[40,40]});
  if(!startMarker){startMarker=L.marker([lat,lng],{icon:iconStart,draggable:true}).addTo(map);
    startMarker.on('dragend', async()=>{const p=startMarker.getLatLng(); startCoord={lat:p.lat,lng:p.lng};
    startAddressText=await reverseGeocode(p.lat,p.lng); document.getElementById('startDisplay').innerText=startAddressText;
    document.getElementById('btnStartNext').style.display='block'; recalcRoute();});}
  else startMarker.setLatLng([lat,lng]);
  map.setView([lat,lng],14);
  reverseGeocode(lat,lng).then(addr=>{startAddressText=addr; document.getElementById('startDisplay').innerText=addr; document.getElementById('btnStartNext').style.display='block'; recalcRoute();});
}

function setDest(lat,lng){
  destCoord={lat,lng};
  const iconDest=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[40,40]});
  if(!destMarker){destMarker=L.marker([lat,lng],{icon:iconDest}).addTo(map);}
  else destMarker.setLatLng([lat,lng]);
  map.setView([lat,lng],14);
  reverseGeocode(lat,lng).then(addr=>{destAddressText=addr; document.getElementById('destDisplay').innerText=addr; document.getElementById('btnDestNext').style.display='block'; recalcRoute();});
}

function recalcRoute(){
  if(startCoord && destCoord){
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[startCoord.lat,startCoord.lng],[destCoord.lat,destCoord.lng]], {color:'blue', weight:5}).addTo(map);
  }
}

function haversineKm(lat1,lon1,lat2,lon2){
  const R=6371, toRad=v=>v*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

document.addEventListener('DOMContentLoaded', ()=>{
  initMap();

  document.getElementById('btnSelectStart').addEventListener('click', ()=>{
    if(!navigator.geolocation){alert('Tarayıcı konum desteklemiyor'); return;}
    navigator.geolocation.getCurrentPosition(pos=>{setStart(pos.coords.latitude,pos.coords.longitude);}, ()=>alert('Konum alınamadı'));
  });

  document.getElementById('startAddress').addEventListener('change', async()=>{
    const res=await geocode(document.getElementById('startAddress').value);
    if(res) setStart(res.lat,res.lng);
    else alert('Adres bulunamadı');
  });

  document.getElementById('btnStartNext').addEventListener('click', ()=>{
    document.getElementById('step1').style.display='none';
    document.getElementById('step2').style.display='flex';
    if(startCoord) map.setView([startCoord.lat,startCoord.lng],14);
  });

  document.getElementById('btnDestSearch').addEventListener('click', async()=>{
    const res=await geocode(document.getElementById('destAddress').value);
    if(res) setDest(res.lat,res.lng);
    else alert('Adres bulunamadı');
  });

  document.getElementById('btnDestNext').addEventListener('click', ()=>{
    if(!destCoord){alert('Hedef seçilmedi'); return;}
    document.getElementById('step2').style.display='none';
    document.getElementById('step3').style.display='flex';

    const km=haversineKm(startCoord.lat,startCoord.lng,destCoord.lat,destCoord.lng);
    const mins=Math.max(1, Math.round((km/AVG_SPEED)*60));
    const price=FIXED_PRICE + Math.round(km*KM_PRICE);
    document.getElementById('resDistance').innerText=km.toFixed(2)+' km';
    document.getElementById('resTime').innerText=mins+' dk';
    document.getElementById('resPrice').innerText=price+' TL';

    map.fitBounds(L.featureGroup([startMarker,destMarker]).getBounds().pad(0.3));
  });

  document.getElementById('btnCallDriver').addEventListener('click', ()=>{
    alert(`Şoför çağrıldı!\nBaşlangıç: ${startAddressText}\nHedef: ${destAddressText}\nÜcret: ${document.getElementById('resPrice').innerText}`);
  });
});
</script>
</body>
</html>
