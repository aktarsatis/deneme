<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nöbetçi24</title>

<!-- Leaflet harita kütüphanesi -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f5f7fa;
  }
  #map {
    height: 60vh;
    width: 100%;
    border-radius: 10px;
    margin-bottom: 10px;
  }
  .container {
    max-width: 600px;
    margin: 15px auto;
    padding: 10px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  input { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; }
  .info { margin-top: 10px; font-size: 14px; }
</style>
</head>
<body>
  <div class="container">
    <h2>🚗 Nöbetçi24 — Mesafe & Fiyat Hesaplayıcı</h2>
    <p>Konumunu alıp gitmek istediğin yeri haritadan seç!</p>

    <div id="map"></div>

    <input id="address" type="text" placeholder="Adres gir (örnek: Kadıköy İstanbul)">
    <button id="findBtn">Adres Bul</button>
    <button id="locateBtn">Konumumu Al</button>
    <button id="clearBtn" style="background:#999;">Temizle</button>

    <div class="info">
      <p>📏 Mesafe: <span id="distance">—</span></p>
      <p>⏱ Tahmini Süre: <span id="time">—</span></p>
      <p>💸 Tahmini Ücret: <span id="price">—</span></p>
    </div>
  </div>

<script>
let map, userMarker, destMarker, userPos;

function initMap() {
  map = L.map('map').setView([41.0082, 28.9784], 12); // İstanbul merkez
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  map.on('click', e => setDestination(e.latlng));
}

function setDestination(latlng) {
  if (destMarker) destMarker.remove();
  destMarker = L.marker(latlng).addTo(map).bindPopup('Hedef').openPopup();
  updateInfo();
}

function updateInfo() {
  if (!userPos || !destMarker) return;

  const R = 6371; // km
  const dLat = (destMarker.getLatLng().lat - userPos.lat) * Math.PI / 180;
  const dLon = (destMarker.getLatLng().lng - userPos.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(userPos.lat*Math.PI/180)*Math.cos(destMarker.getLatLng().lat*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const km = R * c;

  const price = 10 + (km * 3.5);
  const time = (km / 20) * 60; // 20 km/h varsayım

  document.getElementById('distance').textContent = km.toFixed(2) + " km";
  document.getElementById('time').textContent = Math.round(time) + " dk";
  document.getElementById('price').textContent = price.toFixed(2) + " TL";
}

function locateUser() {
  if (!navigator.geolocation) return alert('Tarayıcın konum özelliğini desteklemiyor!');
  navigator.geolocation.getCurrentPosition(pos => {
    userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    if (userMarker) userMarker.remove();
    userMarker = L.marker(userPos).addTo(map).bindPopup('Senin Konumun').openPopup();
    map.setView(userPos, 14);
    updateInfo();
  }, err => alert('Konum alınamadı: ' + err.message));
}

async function findAddress() {
  const addr = document.getElementById('address').value.trim();
  if (!addr) return alert('Adres gir!');
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data[0]) return alert('Adres bulunamadı!');
  const { lat, lon } = data[0];
  const point = L.latLng(lat, lon);
  setDestination(point);
  map.setView(point, 15);
}

document.getElementById('findBtn').onclick = findAddress;
document.getElementById('locateBtn').onclick = locateUser;
document.getElementById('clearBtn').onclick = () => {
  if (destMarker) destMarker.remove();
  destMarker = null;
  document.getElementById('distance').textContent = '—';
  document.getElementById('time').textContent = '—';
  document.getElementById('price').textContent = '—';
};

initMap();
</script>
</body>
</html>
