<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nöbetçi24 — Özel şoför çağır, götürsün</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#0b0f14;
    --card:#0f1720;
    --muted:#9aa4b2;
    --accent:#00c48c; /* marti-yeşil vari */
    --primary:#0f62fe;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:#e6eef8}
  /* container */
  .app{max-width:760px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
  /* header (üst çubuk) */
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:transparent;z-index:40}
  .left{display:flex;align-items:center;gap:10px}
  .menuBtn{width:40px;height:40px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .logo{display:flex;align-items:center;gap:10px}
  .logo h1{font-size:16px;margin:0}
  .profile{width:36px;height:36px;border-radius:50%;background:#111;border:1px solid rgba(255,255,255,0.04)}
  /* map */
  #map {flex:1 1 auto;border-radius:14px;margin:10px 12px 0 12px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
  /* bottom sheet */
  .sheet{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);border-top-left-radius:18px;border-top-right-radius:18px;padding:14px;box-shadow:0 -6px 30px rgba(0,0,0,0.6);margin-top:10px}
  .grab{width:48px;height:6px;background:rgba(255,255,255,0.06);border-radius:6px;margin:0 auto 8px auto}
  .searchRow{display:flex;gap:8px}
  .search{flex:1;display:flex;align-items:center;background:#0b1220;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .search input{background:transparent;border:0;outline:0;color:#e6eef8;font-size:15px;width:100%}
  .btn{background:var(--accent);color:#012;border:0;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  /* cards */
  .cardRow{display:flex;gap:10px;margin-top:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.01));padding:12px;border-radius:12px;flex:1;border:1px solid rgba(255,255,255,0.02);display:flex;gap:12px;align-items:center}
  .card .icon{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center}
  .card h3{margin:0;font-size:15px}
  .card p{margin:0;font-size:13px;color:var(--muted)}
  /* results row */
  .results{display:flex;gap:10px;margin-top:12px}
  .result{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
  .result .val{font-weight:700;font-size:16px}
  .result .lbl{font-size:12px;color:var(--muted)}
  /* call button */
  .callRow{display:flex;gap:10px;margin-top:12px}
  .callBtn{flex:1;background:var(--primary);color:white;padding:12px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
  .callBtn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  /* small */
  .small{font-size:13px;color:var(--muted);margin-top:8px}
  @media (max-width:480px){
    .app{padding-bottom:8px}
    .cardRow{flex-direction:column}
    .results{flex-direction:column}
  }
  /* leaflet dark tweak: reduce contrast */
  .leaflet-container { background: #0b0f14; }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="left">
        <div class="menuBtn" title="Menu">
          <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="2" rx="1" fill="#E6EEF8"/><rect y="5" width="18" height="2" rx="1" fill="#E6EEF8"/><rect y="10" width="18" height="2" rx="1" fill="#E6EEF8"/></svg>
        </div>
        <div class="logo">
          <img src="https://api.iconify.design/mdi/steering.svg?color=%23e6eef8" width="34" height="34" alt="">
          <div>
            <h1>Nöbetçi24</h1>
            <div style="font-size:12px;color:var(--muted)">Özel şoför çağır, götürsün</div>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="profile" title="Profil"></div>
      </div>
    </header>

    <!-- Map -->
    <div id="map"></div>

    <!-- Bottom sheet -->
    <div class="sheet">
      <div class="grab"></div>

      <div class="searchRow">
        <div class="search">
          <input id="inputDest" placeholder="Nereye gitmek istiyorsun? (haritaya tıklayarak da seçebilirsin)" />
        </div>
        <button id="btnFind" class="btn">Bul</button>
      </div>

      <div class="cardRow">
        <div class="card" style="flex:1.6">
          <div class="icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 13v4a1 1 0 0 0 1 1h1a2 2 0 1 0 4 0h6a2 2 0 1 0 4 0h1a1 1 0 0 0 1-1v-4" stroke="#e6eef8" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div>
            <h3>Nöbetçi24</h3>
            <p>Özel şoför çağır, götürsün</p>
          </div>
        </div>

        <!-- fallback controls -->
        <div style="display:flex;flex-direction:column;gap:8px;min-width:160px">
          <button id="btnLocate" class="btn">Konumumu Seç</button>
          <button id="btnSetCenter" class="btn ghost">Harita Merkezini Başlangıç Yap</button>
        </div>
      </div>

      <div class="results" id="results">
        <div class="result">
          <div class="val" id="resDistance">—</div>
          <div class="lbl">Mesafe</div>
        </div>
        <div class="result">
          <div class="val" id="resTime">—</div>
          <div class="lbl">Süre</div>
        </div>
        <div class="result">
          <div class="val" id="resPrice">20 TL</div>
          <div class="lbl">Fiyat (Sabit)</div>
        </div>
      </div>

      <div class="callRow">
        <button id="btnCall" class="callBtn">Şoför Çağır</button>
        <button id="btnClear" class="callBtn secondary">Hedefi Temizle</button>
      </div>

      <div class="small">Not: Konum izni vermiyorsan "Harita Merkezini Başlangıç Yap" ile başlangıç noktası ayarla. Adres araması OpenStreetMap Nominatim ile yapılır (rate-limit olabilir).</div>
    </div>
  </div>

<script>
  // ---- state ----
  let map, origin = null, originMarker = null, destMarker = null;
  const FIXED_PRICE = 20; // sabit 20 TL
  const AVG_SPEED = 20; // km/h used to calc time

  // init map
  function initMap(){
    map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // default view
    map.setView([41.0082, 28.9784], 12);

    // click to set destination
    map.on('click', function(e){
      setDestination(e.latlng.lat, e.latlng.lng);
    });

    // ensure map redraw on load (fix some webview issues)
    setTimeout(()=>{ map.invalidateSize(); }, 300);
  }

  // set origin (user location or center)
  function setOrigin(lat, lng, center=true){
    origin = {lat: Number(lat), lng: Number(lng)};
    if (!originMarker){
      originMarker = L.marker([lat, lng], {draggable:true}).addTo(map).bindPopup('Başlangıç (sürükleyebilirsin)').openPopup();
      originMarker.on('dragend', function(){
        const p = originMarker.getLatLng();
        origin = {lat: p.lat, lng: p.lng};
        recalc();
      });
    } else {
      originMarker.setLatLng([lat, lng]);
    }
    if (center) map.setView([lat, lng], 14);
    recalc();
  }

  // set destination (user taps)
  function setDestination(lat, lng){
    if (destMarker) destMarker.remove();
    destMarker = L.marker([lat, lng], {icon: L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41]})}).addTo(map).bindPopup('Hedef').openPopup();
    // zoom/focus to show both if origin exists
    if (originMarker){
      const group = L.featureGroup([originMarker, destMarker]);
      map.fitBounds(group.getBounds().pad(0.35));
    } else {
      map.setView([lat, lng], 14);
    }
    recalc();
  }

  function clearDestination(){
    if (destMarker) { destMarker.remove(); destMarker = null; }
    document.getElementById('resDistance').innerText = '—';
    document.getElementById('resTime').innerText = '—';
    document.getElementById('resPrice').innerText = FIXED_PRICE + ' TL';
  }

  // haversine
  function haversineKm(lat1, lon1, lat2, lon2){
    const toRad = v => v * Math.PI/180;
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // recalc UI
  function recalc(){
    if (!origin || !destMarker){
      // keep fixed price visible
      document.getElementById('resDistance').innerText = '—';
      document.getElementById('resTime').innerText = '—';
      document.getElementById('resPrice').innerText = FIXED_PRICE + ' TL';
      return;
    }
    const d = destMarker.getLatLng();
    const km = haversineKm(origin.lat, origin.lng, d.lat, d.lng);
    const mins = Math.max(1, Math.round((km / AVG_SPEED) * 60));
    document.getElementById('resDistance').innerText = km.toFixed(2) + ' km';
    document.getElementById('resTime').innerText = mins + ' dk';
    document.getElementById('resPrice').innerText = FIXED_PRICE + ' TL';
  }

  // try geolocation
  function tryLocate(){
    if (!navigator.geolocation){
      alert('Tarayıcınız konum özelliğini desteklemiyor.');
      return;
    }
    navigator.geolocation.getCurrentPosition(function(pos){
      setOrigin(pos.coords.latitude, pos.coords.longitude, true);
    }, function(err){
      console.warn('Geolocation error', err);
      alert('Konum alınamadı. WebViewer/izin problemi olabilir. Bu durumda haritayı başlangıç noktasına getirip "Harita Merkezini Başlangıç Yap" butonunu kullan.');
    }, {enableHighAccuracy:true, timeout:8000});
  }

  // set origin to map center (fallback)
  function setOriginToCenter(){
    const c = map.getCenter();
    setOrigin(c.lat, c.lng, false);
    alert('Başlangıç ayarlandı (harita merkezi). İstersen başlangıç markerını sürükleyebilirsin.');
  }

  // Nominatim geocode
  async function geocode(q){
    try {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const arr = await res.json();
      if (arr && arr.length>0) return {lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon), name: arr[0].display_name};
      return null;
    } catch(e){
      console.error(e);
      return null;
    }
  }

  // events setup
  document.addEventListener('DOMContentLoaded', function(){
    initMap();
    // try auto locate but don't block
    tryLocate();

    document.getElementById('btnLocate').addEventListener('click', function(){ tryLocate(); });
    document.getElementById('btnSetCenter').addEventListener('click', function(){ setOriginToCenter(); });
    document.getElementById('btnClear').addEventListener('click', function(){ clearDestination(); });

    document.getElementById('btnFind').addEventListener('click', async function(){
      const q = document.getElementById('inputDest').value.trim();
      if (!q) { alert('Lütfen hedef adresi girin veya haritaya tıklayın.'); return; }
      this.disabled = true; this.innerText = 'Aranıyor...';
      const found = await geocode(q);
      this.disabled = false; this.innerText = 'Bul';
      if (!found) return alert('Adres bulunamadı.');
      setDestination(found.lat, found.lon);
    });

    document.getElementById('btnCall').addEventListener('click', function(){
      if (!origin) { alert('Lütfen önce başlangıç konumunu seç (Konumumu Seç veya Harita Merkezini Başlangıç Yap).'); return; }
      if (!destMarker) { alert('Lütfen hedefi seç (haritaya tıkla veya adres ile ara).'); return; }
      // burada gerçek çağrı API'si bağlanabilir. Şimdilik demo alert
      const d = destMarker.getLatLng();
      alert('Şoför çağrıldı!\nBaşlangıç: ' + origin.lat.toFixed(5) + ',' + origin.lng.toFixed(5) + '\nHedef: ' + d.lat.toFixed(5) + ',' + d.lng.toFixed(5) + '\nÜcret: ' + FIXED_PRICE + ' TL');
    });
  });
</script>

</body>
</html>
