// ---- state ----
let map, origin = null, originMarker = null, destMarker = null;
const FIXED_PRICE = 20; // sabit 20 TL
const KM_PRICE = 5;     // km başı 5 TL
const AVG_SPEED = 20;   // km/h used to calc time

// init map
function initMap(){
  map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  map.setView([41.0082, 28.9784], 12);

  // haritaya tıklayınca hedef seç
  map.on('click', function(e){
    if (!origin) return alert('Önce başlangıç konumunu seç.');
    setDestination(e.latlng.lat, e.latlng.lng);
  });

  setTimeout(()=>{ map.invalidateSize(); }, 300);
}

// başlangıç ayarla
function setOrigin(lat, lng, center=true){
  origin = {lat: Number(lat), lng: Number(lng)};
  if (!originMarker){
    originMarker = L.marker([lat, lng], {draggable:true}).addTo(map).bindPopup('Başlangıç (sürükleyebilirsin)').openPopup();
    originMarker.on('dragend', function(){
      const p = originMarker.getLatLng();
      origin = {lat: p.lat, lng: p.lng};
      recalc();
    });
  } else {
    originMarker.setLatLng([lat, lng]);
  }
  if (center) map.setView([lat, lng], 14);
  recalc();
}

// hedef ayarla
function setDestination(lat, lng){
  if (!origin) return alert('Önce başlangıç konumunu seç.');
  if (destMarker) destMarker.remove();
  destMarker = L.marker([lat, lng]).addTo(map).bindPopup('Hedef').openPopup();
  const group = L.featureGroup([originMarker, destMarker]);
  map.fitBounds(group.getBounds().pad(0.35));
  recalc();
}

// hedef temizle
function clearDestination(){
  if (destMarker) { destMarker.remove(); destMarker = null; }
  document.getElementById('resDistance').innerText = '—';
  document.getElementById('resTime').innerText = '—';
  document.getElementById('resPrice').innerText = FIXED_PRICE + ' TL';
}

// haversine
function haversineKm(lat1, lon1, lat2, lon2){
  const toRad = v => v * Math.PI/180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// mesafe, süre, fiyat hesapla
function recalc(){
  if (!origin || !destMarker){
    document.getElementById('resDistance').innerText = '—';
    document.getElementById('resTime').innerText = '—';
    document.getElementById('resPrice').innerText = FIXED_PRICE + ' TL';
    return;
  }
  const d = destMarker.getLatLng();
  const km = haversineKm(origin.lat, origin.lng, d.lat, d.lng);
  const mins = Math.max(1, Math.round((km / AVG_SPEED) * 60));
  const price = FIXED_PRICE + Math.round(km * KM_PRICE);
  document.getElementById('resDistance').innerText = km.toFixed(2) + ' km';
  document.getElementById('resTime').innerText = mins + ' dk';
  document.getElementById('resPrice').innerText = price + ' TL';
}

// konum bul
function tryLocate(){
  if (!navigator.geolocation){ alert('Tarayıcınız konum desteklemiyor.'); return; }
  navigator.geolocation.getCurrentPosition(function(pos){
    setOrigin(pos.coords.latitude, pos.coords.longitude, true);
  }, function(){ alert('Konum alınamadı.'); }, {enableHighAccuracy:true, timeout:8000});
}

// harita merkezi → başlangıç
function setOriginToCenter(){
  const c = map.getCenter();
  setOrigin(c.lat, c.lng, false);
  alert('Başlangıç ayarlandı (harita merkezi).');
}

// Nominatim geocode
async function geocode(q){
  try {
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    const arr = await res.json();
    if (arr && arr.length>0) return {lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon), name: arr[0].display_name};
    return null;
  } catch(e){ console.error(e); return null; }
}

// event setup
document.addEventListener('DOMContentLoaded', function(){
  initMap();
  tryLocate();

  document.getElementById('btnLocate').addEventListener('click', tryLocate);
  document.getElementById('btnSetCenter').addEventListener('click', setOriginToCenter);
  document.getElementById('btnClear').addEventListener('click', clearDestination);

  document.getElementById('btnFind').addEventListener('click', async function(){
    const q = document.getElementById('inputDest').value.trim();
    if (!q) return alert('Lütfen hedef adresi girin veya haritaya tıklayın.');
    this.disabled = true; this.innerText = 'Aranıyor...';
    const found = await geocode(q);
    this.disabled = false; this.innerText = 'Bul';
    if (!found) return alert('Adres bulunamadı.');
    setDestination(found.lat, found.lon);
  });

  document.getElementById('btnCall').addEventListener('click', function(){
    if (!origin) return alert('Önce başlangıç konumunu seç.');
    if (!destMarker) return alert('Önce hedefi seç.');
    const d = destMarker.getLatLng();
    alert(`Şoför çağrıldı!\nBaşlangıç: ${origin.lat.toFixed(5)},${origin.lng.toFixed(5)}\nHedef: ${d.lat.toFixed(5)},${d.lng.toFixed(5)}\nÜcret: ${document.getElementById('resPrice').innerText}`);
  });
});
